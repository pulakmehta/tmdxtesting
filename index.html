<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Analytics</title>
</head>
<body>
    <h1>Flight Analytics</h1>
    <div id="loading">Loading flight data...</div>
    <div id="results"></div>

    <script>
        // Dictionary mapping N-number to icao24
        const aircraftDict = {
            'N265TX': 'A2934F', 
            'N282TX': 'A2D728', 
            'N283TX': 'A2DADF', 
            'N284TX': 'A2DE96', 
            'N285TX': 'A2E24D', 
            'N287TX': 'A2E9BB', 
            'N289TX': 'A2F129', 
            'N290TX': 'A2F739', 
            'N291TX': 'A2FAF0', 
            'N293TC': 'A3024B', 
            'N294TX': 'A30615', 
            'N295TX': 'A309CC', 
            'N298TX': 'A314F1', 
            'N300CS': 'A31F95', 
            'N400TE': 'A4AE4F', 
            'N517TX': 'A67D2F', 
            'N65PW': 'A88BBB', 
            'N713DD': 'A98781', 
            'N717DD': 'A9965D', 
            'N80NB': 'AAE0B2'
        };

        // Function to calculate the beginning of the current month in epoch time
        function getStartOfMonth() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return Math.floor(startOfMonth.getTime() / 1000);
        }

        // Function to get current time in epoch
        function getCurrentTime() {
            return Math.floor(Date.now() / 1000);
        }

        // Format date for display
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }

        // Fetch flight data for a specific aircraft
        async function fetchFlightData(icao24, begin, end) {
            try {
                const response = await fetch(`https://opensky-network.org/api/flights/aircraft?icao24=${icao24}&begin=${begin}&end=${end}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching data for ${icao24}:`, error);
                return { error: error.message };
            }
        }

        // Main function to fetch all data and display results
        async function fetchAllFlightData() {
            const startTime = getStartOfMonth();
            const endTime = getCurrentTime();
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            
            resultsDiv.innerHTML = `<p>Date Range: ${formatDate(startTime)} to ${formatDate(endTime)}</p>`;

            // Create table for results
            const table = document.createElement('table');
            table.border = '1';
            table.style.borderCollapse = 'collapse';
            table.innerHTML = `
                <tr>
                    <th>N-Number</th>
                    <th>ICAO24</th>
                    <th>Flights Count</th>
                    <th>Flight Details</th>
                </tr>
            `;
            resultsDiv.appendChild(table);

            // Process each aircraft
            for (const [nNumber, icao24] of Object.entries(aircraftDict)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${nNumber}</td>
                    <td>${icao24}</td>
                    <td>Loading...</td>
                    <td>Loading...</td>
                `;
                table.appendChild(row);
                
                // Fetch data for this aircraft
                const flightData = await fetchFlightData(icao24, startTime, endTime);
                
                // Update the row with the flight data
                if (flightData.error) {
                    row.children[2].textContent = 'Error';
                    row.children[3].textContent = flightData.error;
                } else {
                    row.children[2].textContent = flightData.length || 0;
                    
                    // Create details section
                    const detailsDiv = document.createElement('div');
                    if (flightData.length > 0) {
                        const detailsList = document.createElement('ul');
                        flightData.forEach(flight => {
                            const item = document.createElement('li');
                            item.innerHTML = `
                                Flight: ${flight.callsign || 'N/A'}<br>
                                Departure: ${flight.estDepartureAirport || 'Unknown'} at ${formatDate(flight.firstSeen)}<br>
                                Arrival: ${flight.estArrivalAirport || 'Unknown'} at ${formatDate(flight.lastSeen)}<br>
                            `;
                            detailsList.appendChild(item);
                        });
                        detailsDiv.appendChild(detailsList);
                    } else {
                        detailsDiv.textContent = 'No flights found in this period';
                    }
                    row.children[3].innerHTML = '';
                    row.children[3].appendChild(detailsDiv);
                }
            }
            
            loadingDiv.style.display = 'none';
        }

        // Start fetching data when page loads
        window.onload = fetchAllFlightData;
    </script>
</body>
</html>
